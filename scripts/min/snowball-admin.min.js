!function(e){function l(){e("#publish").on("click",function(){w=!1}),e("#snowball-toolbar").on("click",".button",function(){var l=e(this).data("type");a(l),w=!0}).css("width",e("#snowball-toolbar").parent().width()).fixedsticky(),e("#snowball-main").on("render",".snowball-block",function(){var l=e(this);o(l)}).on("mousedown",".snowball-block",function(){e("#snowball-main").height(e("#snowball-main").height())}).on("mouseup",".snowball-block",function(){e("#snowball-main").height("auto")}).on("input change",".snowball-tinker input, .snowball-tinker textarea",b(function(){var l=e(this).parents(".snowball-block");o(l),c(l),w=!0},250)).on("click",".snowball-delete",function(){var l=e(this).parents(".snowball-block");d(l),w=!0}).on("click",".snowball-zoom-toggle",function(){var l=e(this).parents(".snowball-block");l.find(".snowball-code").toggle(),l.find(".snowball-delete").toggle(),l.toggleClass("modal"),e("body").toggleClass("modal"),t(l),l.find(".CodeMirror").each(function(e,l){l.CodeMirror.refresh()})}).on("mouseover",".snowball-zoom-toggle",function(){var l=e(this).parents(".snowball-block");0===l.find(".snowball-code .CodeMirror").length&&s(l)}).sortable({axis:"y",containment:"#snowball-main",cancel:".snowball-block.modal, textarea, input",cursor:"move"}),e("body").on("click","#modal-bg",function(){e(".snowball-block.modal .snowball-zoom-toggle").click()}),e("body").on("keydown",function(l){27===l.keyCode&&e(".snowball-block.modal .snowball-zoom-toggle").click()}),e(window).resize(b(function(){t()},250)).resize(function(){var l=e(".fixedsticky");l.css("width",l.parent().width())}).on("beforeunload",function(e){return w?"You may have unsaved changes.":void 0}),e("#collapse-menu").click(b(function(){t()},250))}function n(){for(var e in snowball.savedblocks){var l=snowball.savedblocks[e],n=l.blockType.toLowerCase();delete l.blockType,delete l.orderNumber,a(n,l)}}function a(l,n){var a=snowball.blocks[l],t=snowball.names[l],s=e("<div class='snowball-block'><div class='snowball-gui'><div class='snowball-tinker'><div><div class='snowball-title'></div><div class='snowball-title-button snowball-delete'>&times;</div><div class='snowball-title-button snowball-zoom-toggle'><i class='fa fa-search'></i></div></div></div><iframe class='snowball-preview'></iframe></div><div class='snowball-code'><div class='snowball-html snowball-editor'><div class='snowball-code-title'>HTML</div><textarea class='snowball-editor-box' data-mode='xml'></textarea></div><div class='snowball-css snowball-editor'><div class='snowball-code-title'>CSS</div><textarea class='snowball-editor-box' data-mode='css'></textarea></div></div></div>");if(s.addClass("snowball-block-"+l).attr("data-type",l).attr("data-name",t).find(".snowball-title").text(t).end().find(".snowball-tinker").append(a).end(),n)for(var i in n){if(n.hasOwnProperty(i)){var r="[data-target='"+i+"']",c=s.find(r),d=n[i];c&&(c.is(":radio")?c.filter("[value='"+d+"']").prop("checked",!0):c.is(":checkbox")?"true"==d?c.prop("checked",!0):c.prop("checked",!1):c.val(d))}n.customCss&&s.find("textarea[data-mode='css']").html(n.customCss)}else{var w={orderNumber:snowball.savedblocks.length,blockType:l};snowball.savedblocks.push(w)}s.find(".snowball-preview").load(function(){o(s)}).end().find(".wp-color-picker").wpColorPicker({change:b(function(l){e(this).trigger("change").attr("value",e(this).val())},250)}).end().appendTo("#snowball-main").trigger("open")}function o(l){var n=l.data("type"),a="input[type='text'][data-target], input[type='email'][data-target], input[type='range'][data-target], input[type='hidden'][data-target], input[type='radio'][data-target]:checked, input[type='checkbox'][data-target]:checked, textarea[data-target]",o=l.find(a),s=l.find(".snowball-preview").contents(),i=snowball.templates[n],c=l.find(".snowball-code .CodeMirror"),d=snowball.pluginsUrl,b=(snowball.includesUrl,e("<link/>").attr({rel:"stylesheet",href:d+"/styles/snowball.css"})),w=e("<link/>").attr({rel:"stylesheet",href:d+"/styles/snowball-preview.css"}),u=document.createElement("script");u.src=d+"/scripts/snowball-preview.js",o.each(function(l,a){var o=e(this).data("target"),t=e(this).val();"text"===n&&e(this).is("textarea")&&(t=t.replace(/(.+?)\n{2,}/g,"<p>$1</p>")),i=i.replace("{{"+o+"}}",t)}),i=i.replace(/{{.+}}/g,""),i=i.replace(/\[author\]/g,snowball.author).replace(/\[blogname\]/g,snowball.blogname).replace(/\[blogurl\]/g,snowball.blogurl).replace(/\[date\]/g,snowball.date).replace(/\[url\]/g,snowball.url),snowball.title&&(i=i.replace(/\[title\]/g,snowball.title)),s.find("head").is(":empty")&&(s.find("head").append(b,w).end(),s.find("head")[0].appendChild(u));var f,p=e("<style></style>").attr({"data-type":"custom",scoped:"scoped"});if(c.length){var v=c[1].CodeMirror;f=r(v)}else f=l.find("textarea[data-mode='css']").html();f&&p.html(f),s.find("body").html(i).end().find(".snowball-block").append(p),l.width()&&t(l)}function t(l){var n,a,o;l?(n=l.width()/2,a=600>n?n/600:1,o="scale("+a+")",l.find(".snowball-preview").contents().find("html").css({"-webkit-transform":o,transform:o})):e(".snowball-preview").each(function(){n=e(this).parents(".snowball-block").width()/2,a=600>n?n/600:1,o="scale("+a+")",e(this).contents().find("html").css({"-webkit-transform":o,transform:o})})}function s(l){var n=l.find(".snowball-preview").contents().find("body"),a=l.find(".snowball-editor-box");a.each(function(l,a){var t=e(a).attr("data-mode"),s="xml"===t?!0:!1,r=CodeMirror.fromTextArea(a,{mode:{name:t,htmlMode:!0},readOnly:s,lineNumbers:!0,lineWrapping:!0,theme:"monokai"});i(n,t,r),r.on("change",b(function(){var l=e(a).closest(".snowball-block");o(l),w=!0},250))})}function i(l,n,a,o){var t="",s=0;if("css"==n){l.find("style:not([data-type='custom'])").each(function(){t+=e(this).html()}),t?(t=t.replace(/^\n+|\n+$/g,""),t+="\n\n",s=t.split(/\r\n|\r|\n/).length-1):t="",o&&(t+=o);var i=r(a);i&&(t+=i)}else if("xml"===n){var c=l.clone();c.find("style").remove(),t=c.html().replace("\n\n</section>","\n</section>"),s=t.split(/\r\n|\r|\n/).length}var d=a.getCursor(),b=a.getScrollInfo().top,w={line:0,ch:0},u={line:s,ch:0},f={readOnly:!0,inclusiveLeft:!0};a.setValue(t),a.markText(w,u,f);for(var p=0;s>p;p++)a.addLineClass(p,"background","readonly");a.setCursor(d),a.scrollTo(null,b)}function r(e){var l=e.getAllMarks(),n=e.getValue();if(l.length){var a=l[0],o=a.lines.length;if(2>o)n=e.getValue();else{var t={line:o-1,ch:0},s={line:e.lastLine()+1,ch:0};n=e.getRange(t,s)}}return n}function c(e){var l=e.find(".snowball-code .CodeMirror");if(l.length){var n=l[0].CodeMirror,a=l[1].CodeMirror,o=e.find(".snowball-preview").contents().find("body");i(o,"xml",n),i(o,"css",a)}}function d(e){var l=confirm("Are you sure you want to delete this block?");l&&e.trigger("close").remove()}function b(e,l){var n=null;return function(){var a=this,o=arguments;clearTimeout(n),n=setTimeout(function(){e.apply(a,o)},l)}}var w=!1;jQuery(document).ready(function(){l(),snowball.savedblocks=JSON.parse(snowball.savedblocks),null===snowball.savedblocks?snowball.savedblocks=[]:n()})}(jQuery);